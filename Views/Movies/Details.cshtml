@* @model MovieDetailViewModel

@{
    ViewData["Title"] = Model.Movie.Title;
  
   var airedEpisodes = Model.Episodes; // Lấy danh sách tập đã công chiếu
    var airedEpisodesCount = airedEpisodes.Count;
    var firstEpisodeNumber = airedEpisodes.Any() ? airedEpisodes.Min(e => e.EpisodeNumber) : 1;
}
<link rel="stylesheet" href="~/css/home.css" asp-append-version="true" />

<!-- Top Blurred Background Banner -->
<div class="top-banner">
    <div class="overlay"></div>
</div>

<!-- Content Above Banner -->
<div class="container-fluid content-above-banner">
    <div class="movie-header-detail">
        <div class="movie-header-poster">
            <img src="@Model.Movie.PosterDoc" alt="@Model.Movie.Title Poster">
        </div>
        <div class="movie-header-info">
            <h1>@Model.Movie.Title</h1>
            @if (!string.IsNullOrEmpty(Model.Movie.EnglishTitle))
            {
                <h2>@Model.Movie.EnglishTitle</h2>
            }
            <div class="main-action-buttons">
                <a asp-action="Watch" asp-controller="Movies" asp-route-movieId="@Model.Movie.Id" asp-route-episodeNumber="@firstEpisodeNumber" class="btn-watch-now">
                    <i class="fas fa-play"></i> Xem Ngay
                </a>
                @await Html.PartialAsync("_WatchTogetherPartial")
                <div class="action-icon-group">
                    <a href="#" class="action-item"><i class="far fa-heart"></i> Yêu thích</a>
                    <a href="#" class="action-item"><i class="fas fa-plus"></i> Thêm vào</a>
                    <a href="#" class="action-item"><i class="fas fa-share-alt"></i> Chia sẻ</a>
                    <a href="#comments-subtab" class="action-item"><i class="fas fa-comment-dots"></i> Bình luận</a>
                </div>
                <div class="rating-badge">
                    <i class="fas fa-star"></i> @(Model.Ratings.Any() ? Model.Movie.AverageRating.ToString("F1") : "Chưa có") Đánh giá
                </div>
            </div>
        </div>
    </div>

    <!-- Horizontal Navigation Tabs -->
    <div class="horizontal-nav-tabs">
        <a href="#" class="nav-tab-item active" onclick="showContentTab('episodes-tab')">Tập phim</a>
        <a href="#" class="nav-tab-item" onclick="showContentTab('gallery-tab')">Gallery</a>
        <a href="#" class="nav-tab-item" onclick="showContentTab('cast-tab')">Diễn viên</a>
        <a href="#" class="nav-tab-item" onclick="showContentTab('recommendations-tab')">Đề xuất</a>
    </div>
</div>

<!-- Main Content Area -->
<div class="container-fluid main-content-area">
    <div class="row">
        <!-- Left Column -->
        <div class="col-12 col-lg-8">
            <!-- Episodes Tab -->
            <div id="episodes-tab" class="content-tab-pane">
                <div class="movie-meta-info">
                    <span class="meta-tag imdb-rating">
                        <i class="fas fa-star"></i> @(Model.Ratings.Any() ? Model.Movie.AverageRating.ToString("F1") : "Chưa có")
                    </span>
                    <span class="meta-tag age-rating">T16</span>
                    <span class="meta-tag">@Model.Movie.ReleaseYear</span>
                    <span class="meta-tag">Tập @airedEpisodesCount</span>
                </div>

                <div class="genres-list">
                    <span class="genre-item">@Model.Movie.Genre.Name</span>
                    @foreach (var movieGenre in Model.Movie.MovieGenres)
                    {
                        <span class="genre-item">@movieGenre.Genre.Name</span>
                    }
                </div>

                <p class="aired-status">Đã chiếu: @airedEpisodesCount / @Model.Movie.TotalEpisodes tập @(Model.Movie.IsCompleted ? "(Hoàn thành)" : "(Đang cập nhật)")</p>

                <h3 class="section-title">Giới thiệu</h3>
                <p class="movie-description-full">@Model.Movie.Description</p>

                <ul class="movie-details-list">
                    <li><strong>Đạo diễn:</strong> @(Model.Movie.Director ?? "Chưa có thông tin")</li>
                    <li><strong>Quốc gia:</strong> @Model.Movie.Country.Name</li>
                    <li><strong>Lượt xem:</strong> @Model.Movie.Views</li>
                </ul>

                <!-- Next Episode Notification -->
             @if (Model.NextEpisodeScheduleTime.HasValue)
{   
   
    <div class="next-episode-notification">
        <i class="fas fa-bell"></i>
        <span>Tập <strong>@(airedEpisodesCount + 1)</strong> dự kiến phát sóng vào lúc <strong>@Model.NextEpisodeScheduleTime.Value.ToString("HH:mm, dd/MM/yyyy")</strong>. Các bạn nhớ đón xem nhé!</span>
    </div>
}
else if (!Model.Movie.IsCompleted)
{
    <div class="next-episode-notification" style="background: linear-gradient(90deg, #17a2b8, #20c997);">
         <i class="fas fa-info-circle"></i>
         <span>Lịch chiếu tập tiếp theo sẽ được cập nhật sớm.</span>
    </div>
}
                <!-- Episode Selection -->
                <div class="episode-selection-header">
                    <h3>Phần 1</h3>
                    <div class="episode-options">
                        <a href="#" class="episode-option-btn"><i class="fas fa-closed-captioning"></i> Phụ đề</a>
                        <a href="#" class="episode-option-btn"><i class="fas fa-microphone"></i> Thuyết minh</a>
                        <label class="toggle-switch">
                            <input type="checkbox" id="collapseEpisodes">
                            <span class="slider"></span>
                        </label>
                        <span style="font-size: 0.9rem; color: #E0E0E0;">Rút gọn</span>
                    </div>
                </div>

                <div class="episode-buttons-grid" id="episodeGrid">
                    @foreach (var episode in Model.Episodes.OrderBy(e => e.EpisodeNumber))
                    {
                        <a asp-action="Watch" asp-controller="Movies" asp-route-movieId="@Model.Movie.Id" asp-route-episodeNumber="@episode.EpisodeNumber"
                           class="btn @(episode.EpisodeNumber == firstEpisodeNumber ? "active" : "")">Tập @episode.EpisodeNumber</a>
                    }
                </div>
            </div>

            <!-- Gallery Tab -->
            <div id="gallery-tab" class="content-tab-pane" style="display: none;">
                <h3 class="section-title">Gallery</h3>
                <p class="text-muted">Chưa có hình ảnh trong gallery. Nội dung sẽ được cập nhật sớm.</p>
            </div>

            <!-- Cast Tab -->
            <div id="cast-tab" class="content-tab-pane" style="display: none;">
                <h3 class="section-title">Diễn viên</h3>
                @if (!string.IsNullOrWhiteSpace(Model.Movie.Cast))
                {
                    var castMembers = Model.Movie.Cast.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(s => s.Trim()).ToList();
                    <div class="cast-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 20px;">
                        @foreach (var member in castMembers.Take(6))
                        {
                            <div class="cast-member" style="text-align: center;">
                                <img src="https://ui-avatars.com/api/?name=@(Uri.EscapeDataString(member))&background=random&color=fff"
                                     alt="@member" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 8px; border: 2px solid #4C4F62;">
                                <p style="font-size: 0.9rem; color: #E0E0E0; margin: 0;">@member</p>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">Chưa có thông tin diễn viên.</p>
                }
            </div>

            <!-- Recommendations Tab -->
            <div id="recommendations-tab" class="content-tab-pane" style="display: none;">
                <h3 class="section-title">Đề xuất cho bạn</h3>
                @if (Model.RelatedMovies.Any())
                {
                    <div class="recommendation-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        @foreach (var relatedMovie in Model.RelatedMovies.Take(4))
                        {
                            <a asp-action="Details" asp-controller="Movies" asp-route-id="@relatedMovie.Id" class="recommended-movie-card" style="display: flex; text-decoration: none;">
                                <img src="@relatedMovie.PosterDoc" alt="@relatedMovie.Title"
                                     style="width: 90px; height: 130px; object-fit: cover; border-radius: 8px; margin-right: 10px;">
                                <div class="recommended-movie-details">
                                    <h4 style="font-size: 1.1rem; margin-bottom: 5px; color: white;">@relatedMovie.Title</h4>
                                    @if (!string.IsNullOrEmpty(relatedMovie.EnglishTitle))
                                    {
                                        <p style="font-size: 0.9rem; color: #B0B0B0; margin-bottom: 5px;">@relatedMovie.EnglishTitle</p>
                                    }
                                    <div class="recommended-movie-meta" style="display: flex; flex-wrap: wrap; gap: 5px; font-size: 0.8rem; color: #9C9C9C;">
                                        <span style="background-color: #4C4F62; padding: 3px 8px; border-radius: 3px;">T16</span>
                                        <span style="background-color: #4C4F62; padding: 3px 8px; border-radius: 3px;">Tập @relatedMovie.TotalEpisodes</span>
                                    </div>
                                </div>
                            </a>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">Không có phim đề xuất.</p>
                }
            </div>

            <!-- Comment & Rating Section -->
            <div class="comment-section-wrapper">
                <div class="comment-tabs">
                    <button class="comment-tab-btn active" onclick="showCommentRatingTab('comments-subtab')">Bình luận (@Model.Comments.Count(c => c.EpisodeId == null))</button>
                    <button class="comment-tab-btn" onclick="showCommentRatingTab('ratings-subtab')">Đánh giá (@Model.Ratings.Count())</button>
                </div>

                <!-- Comments Subtab -->
                <div id="comments-subtab" class="comment-rating-subtab">
                    <div class="login-prompt">
                        Vui lòng <a asp-controller="Account" asp-action="Login">đăng nhập</a> để tham gia bình luận.
                    </div>

                    <!-- Comment Form -->
                    <form asp-action="AddComment" asp-controller="Movies" method="post" class="comment-form mb-4">
                        <input type="hidden" asp-for="NewComment.MovieId" />
                        <input type="hidden" asp-for="NewComment.EpisodeId" />
                        <div class="form-group">
                            <label asp-for="NewComment.UserName" class="sr-only"></label>
                            <input asp-for="NewComment.UserName" class="form-control" placeholder="Tên của bạn" />
                            <span asp-validation-for="NewComment.UserName" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="NewComment.UserEmail" class="sr-only"></label>
                            <input asp-for="NewComment.UserEmail" class="form-control" placeholder="Email của bạn" />
                            <span asp-validation-for="NewComment.UserEmail" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <textarea asp-for="NewComment.Content" class="form-control" rows="4" placeholder="Viết bình luận"></textarea>
                            <span asp-validation-for="NewComment.Content" class="text-danger"></span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="d-flex align-items-center">
                                <label class="toggle-switch">
                                    <input type="checkbox" name="IsSpoiler">
                                    <span class="slider"></span>
                                </label>
                                <span style="font-size: 0.9rem; color: #D0D0D0; margin-left: 5px;">Tiết lộ?</span>
                            </div>
                            <button type="submit" class="btn-submit-comment">Gửi <i class="fas fa-paper-plane ml-2"></i></button>
                        </div>
                    </form>

                    <!-- Comments Display -->
                    @if (Model.Comments.Any(c => c.EpisodeId == null))
                    {
                        @foreach (var comment in Model.Comments.Where(c => c.EpisodeId == null && c.ParentCommentId == null).OrderByDescending(c => c.CreatedAt))
                        {
                            <div class="comment-item">
                                <div class="comment-header">
                                    <img src="https://ui-avatars.com/api/?name=@(Uri.EscapeDataString(comment.UserName))&background=random&color=fff" alt="Avatar" class="user-avatar">
                                    <span class="user-name">@comment.UserName</span>
                                    <span class="comment-meta">@comment.CreatedAt.ToString("HH:mm dd/MM/yyyy")</span>
                                </div>
                                <p class="comment-content">@comment.Content</p>
                                <div class="comment-actions">
                                    <span><i class="far fa-thumbs-up"></i> @comment.Likes</span>
                                    <span><i class="far fa-thumbs-down"></i> @comment.Dislikes</span>
                                    <a href="#" onclick="showReplyForm(@comment.Id)">Trả lời</a>
                                </div>
                                @if (comment.Replies.Any())
                                {
                                    <div class="replies">
                                        @foreach (var reply in comment.Replies.OrderBy(r => r.CreatedAt))
                                        {
                                            <div class="comment-item">
                                                <div class="comment-header">
                                                    <img src="https://ui-avatars.com/api/?name=@(Uri.EscapeDataString(reply.UserName))&background=random&color=fff" alt="Avatar" class="user-avatar">
                                                    <span class="user-name">@reply.UserName</span>
                                                    <span class="comment-meta">@reply.CreatedAt.ToString("HH:mm dd/MM/yyyy")</span>
                                                </div>
                                                <p class="comment-content">@reply.Content</p>
                                                <div class="comment-actions">
                                                    <span><i class="far fa-thumbs-up"></i> @reply.Likes</span>
                                                    <span><i class="far fa-thumbs-down"></i> @reply.Dislikes</span>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                <form asp-action="AddComment" asp-controller="Movies" method="post" class="comment-form mb-4 reply-form" id="reply-form-@comment.Id" style="display: none;">
                                    <input type="hidden" asp-for="NewComment.MovieId" />
                                    <input type="hidden" asp-for="NewComment.EpisodeId" />
                                    <input type="hidden" asp-for="NewComment.ParentCommentId" value="@comment.Id" />
                                    <div class="form-group">
                                        <label asp-for="NewComment.UserName" class="sr-only"></label>
                                        <input asp-for="NewComment.UserName" class="form-control" placeholder="Tên của bạn" />
                                        <span asp-validation-for="NewComment.UserName" class="text-danger"></span>
                                    </div>
                                    <div class="form-group">
                                        <label asp-for="NewComment.UserEmail" class="sr-only"></label>
                                        <input asp-for="NewComment.UserEmail" class="form-control" placeholder="Email của bạn" />
                                        <span asp-validation-for="NewComment.UserEmail" class="text-danger"></span>
                                    </div>
                                    <div class="form-group">
                                        <textarea asp-for="NewComment.Content" class="form-control" rows="3" placeholder="Viết câu trả lời"></textarea>
                                        <span asp-validation-for="NewComment.Content" class="text-danger"></span>
                                    </div>
                                    <button type="submit" class="btn-submit-comment">Gửi trả lời</button>
                                </form>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-center text-muted">Chưa có bình luận nào cho phim này. Hãy là người đầu tiên bình luận!</p>
                    }
                </div>

                <!-- Ratings Subtab -->
                <div id="ratings-subtab" class="comment-rating-subtab" style="display: none;">
                    <h3 class="section-title">Đánh giá từ người xem</h3>
                    <form asp-action="AddRating" asp-controller="Movies" method="post" class="comment-form mb-4">
                        <input type="hidden" asp-for="NewRating.MovieId" />
                        <div class="form-group">
                            <label asp-for="NewRating.UserName" class="sr-only"></label>
                            <input asp-for="NewRating.UserName" class="form-control" placeholder="Tên của bạn" />
                            <span asp-validation-for="NewRating.UserName" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="NewRating.UserEmail" class="sr-only"></label>
                            <input asp-for="NewRating.UserEmail" class="form-control" placeholder="Email của bạn" />
                            <span asp-validation-for="NewRating.UserEmail" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="NewRating.Score"></label>
                            <select asp-for="NewRating.Score" class="form-control">
                                @for (int i = 1; i <= 10; i++)
                                {
                                    <option value="@i">@i</option>
                                }
                            </select>
                            <span asp-validation-for="NewRating.Score" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <textarea asp-for="NewRating.Review" class="form-control" rows="4" placeholder="Viết nhận xét"></textarea>
                            <span asp-validation-for="NewRating.Review" class="text-danger"></span>
                        </div>
                        <button type="submit" class="btn-submit-comment">Gửi đánh giá</button>
                    </form>

                    @if (Model.Ratings.Any())
                    {
                        @foreach (var rating in Model.Ratings.OrderByDescending(r => r.CreatedAt))
                        {
                            <div class="comment-item">
                                <div class="comment-header">
                                    <img src="https://ui-avatars.com/api/?name=@(Uri.EscapeDataString(rating.UserName))&background=2196F3&color=fff" alt="Avatar" class="user-avatar" style="border-color: #2196F3;">
                                    <span class="user-name" style="color: #2196F3;">@rating.UserName</span>
                                    <span class="comment-meta">@rating.CreatedAt.ToString("dd/MM/yyyy")</span>
                                </div>
                                <p class="comment-content">
                                    Điểm: <strong>@rating.Score/10</strong> <i class="fas fa-star" style="color: #FFC107;"></i>
                                    @if (!string.IsNullOrWhiteSpace(rating.Review))
                                    {
                                        <br />@rating.Review
                                    }
                                </p>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-center text-muted">Chưa có đánh giá nào cho phim này. Hãy là người đầu tiên đánh giá!</p>
                    }
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-12 col-lg-4">
            <!-- Placeholder for right column content -->
            <h3 class="section-title">Thông tin thêm</h3>
            <p class="text-muted">Nội dung bổ sung sẽ được cập nhật sớm.</p>
        </div>
    </div>
</div>

@section Scripts {
    

    <script>
        function showContentTab(tabId) {
            document.querySelectorAll('.content-tab-pane').forEach(pane => pane.style.display = 'none');
            document.querySelectorAll('.horizontal-nav-tabs .nav-tab-item').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            document.querySelector(`.nav-tab-item[onclick="showContentTab('${tabId}')"]`).classList.add('active');
        }

        function showCommentRatingTab(tabId) {
            document.querySelectorAll('.comment-rating-subtab').forEach(subtab => subtab.style.display = 'none');
            document.querySelectorAll('.comment-tabs .comment-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            document.querySelector(`.comment-tab-btn[onclick="showCommentRatingTab('${tabId}')"]`).classList.add('active');
        }

        function showReplyForm(commentId) {
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            showContentTab('episodes-tab');
            showCommentRatingTab('comments-subtab');

            const collapseToggle = document.getElementById('collapseEpisodes');
            const episodeGrid = document.getElementById('episodeGrid');
            collapseToggle.addEventListener('change', function() {
                episodeGrid.style.display = this.checked ? 'none' : 'flex';
            });
        });
    </script>
} *@

@model MovieDetailViewModel

@{
    ViewData["Title"] = Model.Movie.Title;
    // Use ViewModel properties for consistency with controller data
    @* var airedEpisodesCount = Model.AiredEpisodesCount; *@
    // Calculate firstEpisodeNumber from Model.Episodes. Ensure this logic aligns with your desired behavior.
    // The controller's Details action already calculated this, so using that value is preferred if passed.
    // Fallback calculation if controller didn't pass it:
     var airedEpisodes = Model.Episodes; // Lấy danh sách tập đã công chiếu
    var airedEpisodesCount = airedEpisodes.Count;
    @* var firstEpisodeNumber = airedEpisodes.Any() ? airedEpisodes.Min(e => e.EpisodeNumber) : 1; *@

    
    var firstEpisodeNumber = Model.Episodes.Any() ? Model.Episodes.OrderBy(e => e.EpisodeNumber).FirstOrDefault()?.EpisodeNumber ?? 1 : 1;
}
@* Ensure your main CSS files are linked in _Layout.cshtml.
   If home.css is project-specific, it's fine to link it here. *@
<link rel="stylesheet" href="~/css/details.css" asp-append-version="true" />

<style>   .top-banner {
        position: relative;
        width: 100%;
        height: 900px;
        background-image: url('@Model.Movie.PosterPath');
        background-size: cover;
        background-position: center;
        filter: blur(3px);
        -webkit-filter: blur(8px);
        z-index: 0;
    }</style>

<!-- Top Blurred Background Banner -->
<div class="top-banner">
    <div class="overlay"></div>
</div>

<!-- Content Above Banner -->
<div class="container-fluid content-above-banner">
    <div class="movie-header-detail">
        <div class="movie-header-poster">
            <img src="@Model.Movie.PosterDoc" alt="@Model.Movie.Title Poster">
        </div>
        <div class="movie-header-info">
            <h1>@Model.Movie.Title</h1>
            @if (!string.IsNullOrEmpty(Model.Movie.EnglishTitle))
            {
                <h2>@Model.Movie.EnglishTitle</h2>
            }
            <div class="main-action-buttons">
                <a asp-action="Watch" asp-controller="Movies" asp-route-movieId="@Model.Movie.Id" asp-route-episodeNumber="@firstEpisodeNumber" class="btn-watch-now">
                    <i class="fas fa-play"></i> Xem Ngay
                </a>
                @{
        ViewBag.CurrentMovieId = Model.Movie.Id;
    }
    @await Html.PartialAsync("_WatchTogetherPartial")
                <div class="action-icon-group">
                    @* --- MODIFIED FAVORITE LINK --- *@
                    <a href="#"
                       id="favorite-action-link"
                       class="action-item @(Model.IsUserLoggedIn && Model.HasFavorited ? "favorited" : "")"
                       data-movie-id="@Model.Movie.Id"
                       data-user-id="@Model.UserId" @* Pass the current user's ID *@
                       data-is-favorited="@(Model.IsUserLoggedIn && Model.HasFavorited ? "true" : "false")">
                        <i class="@(Model.IsUserLoggedIn && Model.HasFavorited ? "fas fa-heart" : "far fa-heart")"></i> Yêu thích
                    </a>

                    @* --- END MODIFIED FAVORITE LINK --- *@
                    <a href="#" class="action-item"><i class="fas fa-plus"></i> Thêm vào</a>
                    <a href="#" class="action-item"><i class="fas fa-share-alt"></i> Chia sẻ</a>
                    <a href="#comments-subtab" class="action-item"><i class="fas fa-comment-dots"></i> Bình luận</a>
                </div>
                <div class="rating-badge">
                    <i class="fas fa-star"></i> @(Model.Ratings.Any() ? Model.Movie.AverageRating.ToString("F1") : "Chưa có") Đánh giá
                </div>
                
            </div>
        </div>
    </div>

    <!-- Horizontal Navigation Tabs -->
    <div class="horizontal-nav-tabs">
        <a href="#" class="nav-tab-item active" onclick="showContentTab('episodes-tab'); return false;">Tập phim</a>
        <a href="#" class="nav-tab-item" onclick="showContentTab('gallery-tab'); return false;">Gallery</a>
        <a href="#" class="nav-tab-item" onclick="showContentTab('cast-tab'); return false;">Diễn viên</a>
        <a href="#" class="nav-tab-item" onclick="showContentTab('recommendations-tab'); return false;">Đề xuất</a>
    </div>
</div>

<!-- Main Content Area -->
<div class="container-fluid main-content-area">
    <div class="row">
        <!-- Left Column -->
        <div class="col-12 col-lg-8">
            <!-- Episodes Tab -->
            <div id="episodes-tab" class="content-tab-pane">
                <div class="movie-meta-info">
                    <span class="meta-tag imdb-rating">
                        <i class="fas fa-star"></i> @(Model.Ratings.Any() ? Model.Movie.AverageRating.ToString("F1") : "Chưa có")
                    </span>
                    <span class="meta-tag age-rating">T16</span> @* Example age rating, should ideally be dynamic *@
                    <span class="meta-tag">@Model.Movie.ReleaseYear</span>
                    <span class="meta-tag">Tập @airedEpisodesCount</span> @* Use ViewModel's count *@
                </div>

                <div class="genres-list">
                    @if (Model.Movie.Genre != null) @* Safety check for Genre object *@
                    {
                        <span class="genre-item">@Model.Movie.Genre.Name</span>
                    }
                    @foreach (var movieGenre in Model.Movie.MovieGenres)
                    {
                        <span class="genre-item">@movieGenre.Genre.Name</span>
                    }
                </div>

                <p class="aired-status">Đã chiếu: @airedEpisodesCount / @Model.Movie.TotalEpisodes tập @(Model.Movie.IsCompleted ? "(Hoàn thành)" : "(Đang cập nhật)")</p>

                <h3 class="section-title">Giới thiệu</h3>
                <p class="movie-description-full">@Model.Movie.Description</p>

                <ul class="movie-details-list">
                    <li><strong>Đạo diễn:</strong> @(Model.Movie.Director ?? "Chưa có thông tin")</li>
                    <li><strong>Quốc gia:</strong> @(Model.Movie.Country?.Name ?? "Chưa có thông tin")</li> @* Safety check for Country object *@
                    <li><strong>Lượt xem:</strong> @Model.Movie.Views</li>
                </ul>

                @* <!-- Next Episode Notification -->
                @if (Model.NextEpisodeScheduleTime.HasValue)
                {
                    <div class="next-episode-notification">
                        <i class="fas fa-bell"></i>
                        <span>Tập <strong>@(airedEpisodesCount + 1)</strong> dự kiến phát sóng vào lúc <strong>@Model.NextEpisodeScheduleTime.Value.ToString("HH:mm, dd/MM/yyyy")</strong>. Các bạn nhớ đón xem nhé!</span>
                    </div>
                }
                else if (!Model.Movie.IsCompleted)
                {
                    <div class="next-episode-notification" style="background: linear-gradient(90deg, #17a2b8, #20c997);">
                        <i class="fas fa-info-circle"></i>
                        <span>Lịch chiếu tập tiếp theo sẽ được cập nhật sớm.</span>
                    </div>
                } *@

                 <!-- Next Episode Notification -->
             @if (Model.NextEpisodeScheduleTime.HasValue)
                {
                    var nextEpisodeNum = Model.AiredEpisodes.Any() ? Model.AiredEpisodes.Max(e => e.EpisodeNumber) + 1 : 1;
                    var releaseTime = Model.NextEpisodeScheduleTime.Value.ToLocalTime();

                    <div class="next-episode-notification">
                        <i class="fas fa-bell icon"></i>
                        <span class="info-text">
                            Tập @nextEpisodeNum dự kiến phát sóng vào @releaseTime.ToString("HH:mm") ngày @releaseTime.ToString("dd/MM/yyyy").
                        </span>
                        <span class="countdown-text" id="countdown-timer" data-release-time="@Model.NextEpisodeScheduleTime.Value.ToString("o")">
                            <!-- JavaScript sẽ điền nội dung đếm ngược vào đây -->
                        </span>
                    </div>
                }
                else if (!Model.Movie.IsCompleted)
                {
                    // Thêm class "updating" để có màu khác
                    <div class="next-episode-notification" style="background: linear-gradient(90deg, #17a2b8, #20c997);">
                            <i class="fas fa-info-circle icon"></i>
                        <span class="info-text">Phim đang được cập nhật. Lịch chiếu tập mới sẽ được thông báo sớm nhất.</span>
                    </div>
                }
                <!-- Episode Selection -->
                <div class="episode-selection-header">
                    <h3>Phần 1</h3> @* Assuming only one part, adjust if your movie structure has multiple parts *@
                    <div class="episode-options">
                        <a href="#" class="episode-option-btn"><i class="fas fa-closed-captioning"></i> Phụ đề</a>
                        <a href="#" class="episode-option-btn"><i class="fas fa-microphone"></i> Thuyết minh</a>
                        <label class="toggle-switch">
                            <input type="checkbox" id="collapseEpisodes">
                            <span class="slider"></span>
                        </label>
                        <span style="font-size: 0.9rem; color: #E0E0E0;">Rút gọn</span>
                    </div>
                </div>

                <div class="episode-buttons-grid" id="episodeGrid">
                    @foreach (var episode in Model.Episodes.OrderBy(e => e.EpisodeNumber))
                    {
                        <a asp-action="Watch" asp-controller="Movies" asp-route-movieId="@Model.Movie.Id" asp-route-episodeNumber="@episode.EpisodeNumber"
                           class="btn @(episode.EpisodeNumber == firstEpisodeNumber ? "active" : "")">Tập @episode.EpisodeNumber</a>
                    }
                </div>
            </div>

            <!-- Gallery Tab -->
            <div id="gallery-tab" class="content-tab-pane" style="display: none;">
                <h3 class="section-title">Gallery</h3>
                <p class="text-muted">Chưa có hình ảnh trong gallery. Nội dung sẽ được cập nhật sớm.</p>
            </div>

            <!-- Cast Tab -->
            <div id="cast-tab" class="content-tab-pane" style="display: none;">
                <h3 class="section-title">Diễn viên</h3>
                @if (!string.IsNullOrWhiteSpace(Model.Movie.Cast))
                {
                    var castMembers = Model.Movie.Cast.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(s => s.Trim()).ToList();
                    <div class="cast-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 20px;">
                        @foreach (var member in castMembers.Take(6))
                        {
                            <div class="cast-member" style="text-align: center;">
                                @* Using a placeholder avatar service for demonstration *@
                                <img src="https://ui-avatars.com/api/?name=@(Uri.EscapeDataString(member))&background=random&color=fff"
                                     alt="@member" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 8px; border: 2px solid #4C4F62;">
                                <p style="font-size: 0.9rem; color: #E0E0E0; margin: 0;">@member</p>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">Chưa có thông tin diễn viên.</p>
                }
            </div>

            <!-- Recommendations Tab -->
            <div id="recommendations-tab" class="content-tab-pane" style="display: none;">
                <h3 class="section-title">Đề xuất cho bạn</h3>
                @if (Model.RelatedMovies.Any())
                {
                    <div class="recommendation-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        @foreach (var relatedMovie in Model.RelatedMovies.Take(4))
                        {
                            <a asp-action="Details" asp-controller="Movies" asp-route-id="@relatedMovie.Id" class="recommended-movie-card" style="display: flex; text-decoration: none;">
                                <img src="@relatedMovie.PosterDoc" alt="@relatedMovie.Title"
                                     style="width: 90px; height: 130px; object-fit: cover; border-radius: 8px; margin-right: 10px;">
                                <div class="recommended-movie-details">
                                    <h4 style="font-size: 1.1rem; margin-bottom: 5px; color: white;">@relatedMovie.Title</h4>
                                    @if (!string.IsNullOrEmpty(relatedMovie.EnglishTitle))
                                    {
                                        <p style="font-size: 0.9rem; color: #B0B0B0; margin-bottom: 5px;">@relatedMovie.EnglishTitle</p>
                                    }
                                    <div class="recommended-movie-meta" style="display: flex; flex-wrap: wrap; gap: 5px; font-size: 0.8rem; color: #9C9C9C;">
                                        <span style="background-color: #4C4F62; padding: 3px 8px; border-radius: 3px;">T16</span> @* Example rating, should be dynamic *@
                                        <span style="background-color: #4C4F62; padding: 3px 8px; border-radius: 3px;">Tập @relatedMovie.TotalEpisodes</span>
                                    </div>
                                </div>
                            </a>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">Không có phim đề xuất.</p>
                }
            </div>

            <!-- Comment & Rating Section -->
            <div class="comment-section-wrapper">
                <div class="comment-tabs">
                    <button class="comment-tab-btn active" onclick="showCommentRatingTab('comments-subtab'); return false;">Bình luận (@Model.Comments.Count(c => c.EpisodeId == null))</button>
                    <button class="comment-tab-btn" onclick="showCommentRatingTab('ratings-subtab'); return false;">Đánh giá (@Model.Ratings.Count())</button>
                </div>

                <!-- Comments Subtab -->
                <div id="comments-subtab" class="comment-rating-subtab">
                    @if (!Model.IsUserLoggedIn)
                    {
                        <div class="login-prompt">
                            Vui lòng <a asp-controller="Account" asp-action="Login">đăng nhập</a> để tham gia bình luận.
                        </div>
                    }
                    else
                    {
                        <!-- Comment Form (Only if logged in) -->
                        <form asp-action="AddComment" asp-controller="Movies" method="post" class="comment-form mb-4">
                            <input type="hidden" asp-for="NewComment.MovieId" />
                            <input type="hidden" asp-for="NewComment.EpisodeId" /> @* This is null for movie-level comments *@
                            @* If you implement nested replies, you'll need a hidden input for ParentCommentId here,
                                or dynamically set it when the reply form is shown. *@
                            @* <input type="hidden" asp-for="NewComment.ParentCommentId" /> *@

                            <div class="form-group">
                                @* Make fields readonly if user is logged in and data is pre-filled *@
                                <input asp-for="NewComment.UserName" class="form-control" placeholder="Tên của bạn" readonly="@Model.IsUserLoggedIn" />
                                <span asp-validation-for="NewComment.UserName" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <input asp-for="NewComment.UserEmail" class="form-control" placeholder="Email của bạn" readonly="@Model.IsUserLoggedIn" />
                                <span asp-validation-for="NewComment.UserEmail" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <textarea asp-for="NewComment.Content" class="form-control" rows="4" placeholder="Viết bình luận"></textarea>
                                <span asp-validation-for="NewComment.Content" class="text-danger"></span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="d-flex align-items-center">
                                    <label class="toggle-switch">
                                        <input type="checkbox" name="IsSpoiler">
                                        <span class="slider"></span>
                                    </label>
                                    <span style="font-size: 0.9rem; color: #D0D0D0; margin-left: 5px;">Tiết lộ?</span>
                                </div>
                                <button type="submit" class="btn-submit-comment">Gửi <i class="fas fa-paper-plane ml-2"></i></button>
                            </div>
                        </form>
                    }

                    <!-- Comments Display -->
                    @if (Model.Comments.Any(c => c.EpisodeId == null))
                    {
                        @foreach (var comment in Model.Comments.Where(c => c.EpisodeId == null && c.ParentCommentId == null).OrderByDescending(c => c.CreatedAt))
                        {
                            <div class="comment-item">
                                <div class="comment-header">
                                    <img src="https://ui-avatars.com/api/?name=@(Uri.EscapeDataString(comment.UserName))&background=random&color=fff" alt="Avatar" class="user-avatar">
                                    <span class="user-name">@comment.UserName</span>
                                    <span class="comment-meta">@comment.CreatedAt.ToString("HH:mm dd/MM/yyyy")</span>
                                </div>
                                <p class="comment-content">@comment.Content</p>
                                <div class="comment-actions">
                                    <span><i class="far fa-thumbs-up"></i> @comment.Likes</span>
                                    <span><i class="far fa-thumbs-down"></i> @comment.Dislikes</span>
                                    @if (Model.IsUserLoggedIn) @* Only show reply link if logged in *@
                                    {
                                        <a href="#" onclick="showReplyForm(@comment.Id); return false;">Trả lời</a>
                                    }
                                </div>
                                @if (comment.Replies != null && comment.Replies.Any())
                                {
                                    <div class="replies">
                                        @foreach (var reply in comment.Replies.OrderBy(r => r.CreatedAt))
                                        {
                                            <div class="comment-item">
                                                <div class="comment-header">
                                                    <img src="https://ui-avatars.com/api/?name=@(Uri.EscapeDataString(reply.UserName))&background=random&color=fff" alt="Avatar" class="user-avatar">
                                                    <span class="user-name">@reply.UserName</span>
                                                    <span class="comment-meta">@reply.CreatedAt.ToString("HH:mm dd/MM/yyyy")</span>
                                                </div>
                                                <p class="comment-content">@reply.Content</p>
                                                <div class="comment-actions">
                                                    <span><i class="far fa-thumbs-up"></i> @reply.Likes</span>
                                                    <span><i class="far fa-thumbs-down"></i> @reply.Dislikes</span>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                @if (Model.IsUserLoggedIn) @* Show reply form only if logged in *@
                                {
                                    <form asp-action="AddComment" asp-controller="Movies" method="post" class="comment-form mb-4 reply-form" id="reply-form-@comment.Id" style="display: none;">
                                        <input type="hidden" asp-for="NewComment.MovieId" />
                                        <input type="hidden" asp-for="NewComment.EpisodeId" />
                                        <input type="hidden" asp-for="NewComment.ParentCommentId" value="@comment.Id" />
                                        <div class="form-group">
                                            <input asp-for="NewComment.UserName" class="form-control" placeholder="Tên của bạn" readonly="@Model.IsUserLoggedIn" />
                                            <span asp-validation-for="NewComment.UserName" class="text-danger"></span>
                                        </div>
                                        <div class="form-group">
                                            <input asp-for="NewComment.UserEmail" class="form-control" placeholder="Email của bạn" readonly="@Model.IsUserLoggedIn" />
                                            <span asp-validation-for="NewComment.UserEmail" class="text-danger"></span>
                                        </div>
                                        <div class="form-group">
                                            <textarea asp-for="NewComment.Content" class="form-control" rows="3" placeholder="Viết câu trả lời"></textarea>
                                            <span asp-validation-for="NewComment.Content" class="text-danger"></span>
                                        </div>
                                        <button type="submit" class="btn-submit-comment">Gửi trả lời</button>
                                    </form>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-center text-muted">Chưa có bình luận nào cho phim này. Hãy là người đầu tiên bình luận!</p>
                    }
                </div>

                <!-- Ratings Subtab -->
                <div id="ratings-subtab" class="comment-rating-subtab" style="display: none;">
                    <h3 class="section-title">Đánh giá từ người xem</h3>
                    @if (!Model.IsUserLoggedIn)
                    {
                        <div class="login-prompt">
                            Vui lòng <a asp-controller="Account" asp-action="Login">đăng nhập</a> để đánh giá phim.
                        </div>
                    }
                    else
                    {
                        <form asp-action="AddRating" asp-controller="Movies" method="post" class="comment-form mb-4">
                            <input type="hidden" asp-for="NewRating.MovieId" />
                            <div class="form-group">
                                <input asp-for="NewRating.UserName" class="form-control" placeholder="Tên của bạn" readonly="@Model.IsUserLoggedIn" />
                                <span asp-validation-for="NewRating.UserName" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <input asp-for="NewRating.UserEmail" class="form-control" placeholder="Email của bạn" readonly="@Model.IsUserLoggedIn" />
                                <span asp-validation-for="NewRating.UserEmail" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="NewRating.Score"></label>
                                <select asp-for="NewRating.Score" class="form-control">
                                    @for (int i = 1; i <= 10; i++)
                                    {
                                        <option value="@i">@i</option>
                                    }
                                </select>
                                <span asp-validation-for="NewRating.Score" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <textarea asp-for="NewRating.Review" class="form-control" rows="4" placeholder="Viết nhận xét"></textarea>
                                <span asp-validation-for="NewRating.Review" class="text-danger"></span>
                            </div>
                            <button type="submit" class="btn-submit-comment">Gửi đánh giá</button>
                        </form>
                    }

                    @if (Model.Ratings.Any())
                    {
                        @foreach (var rating in Model.Ratings.OrderByDescending(r => r.CreatedAt))
                        {
                            <div class="comment-item">
                                <div class="comment-header">
                                    <img src="https://ui-avatars.com/api/?name=@(Uri.EscapeDataString(rating.UserName))&background=2196F3&color=fff" alt="Avatar" class="user-avatar" style="border-color: #2196F3;">
                                    <span class="user-name" style="color: #2196F3;">@rating.UserName</span>
                                    <span class="comment-meta">@rating.CreatedAt.ToString("dd/MM/yyyy")</span>
                                </div>
                                <p class="comment-content">
                                    Điểm: <strong>@rating.Score/10</strong> <i class="fas fa-star" style="color: #FFC107;"></i>
                                    @if (!string.IsNullOrWhiteSpace(rating.Review))
                                    {
                                        <br />@rating.Review
                                    }
                                </p>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-center text-muted">Chưa có đánh giá nào cho phim này. Hãy là người đầu tiên đánh giá!</p>
                    }
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-12 col-lg-4">
            <h3 class="section-title">Thông tin thêm</h3>
            <p class="text-muted">Nội dung bổ sung sẽ được cập nhật sớm.</p>
        </div>
    </div>
</div>

@section Scripts {
    @* Ensure you have jQuery included in your _Layout.cshtml if using $(document).ready and $.ajax *@
    @* The _ValidationScriptsPartial tag helper is needed for client-side validation of forms *@
    @* <partial name="_ValidationScriptsPartial" /> *@

    <script>
        // Function to show content tabs
        function showContentTab(tabId) {
            // Hide all content panes
            document.querySelectorAll('.content-tab-pane').forEach(pane => pane.style.display = 'none');
            // Remove active class from all tab buttons
            document.querySelectorAll('.horizontal-nav-tabs .nav-tab-item').forEach(btn => btn.classList.remove('active'));
            // Show the selected content pane
            document.getElementById(tabId).style.display = 'block';
            // Add active class to the clicked tab button
            document.querySelector(`.nav-tab-item[onclick="showContentTab('${tabId}'); return false;"]`).classList.add('active');
        }

        // Function to show comment/rating subtabs
        function showCommentRatingTab(tabId) {
            // Hide all subtab panes
            document.querySelectorAll('.comment-rating-subtab').forEach(subtab => subtab.style.display = 'none');
            // Remove active class from all subtab buttons
            document.querySelectorAll('.comment-tabs .comment-tab-btn').forEach(btn => btn.classList.remove('active'));
            // Show the selected subtab pane
            document.getElementById(tabId).style.display = 'block';
            // Add active class to the clicked subtab button
            document.querySelector(`.comment-tab-btn[onclick="showCommentRatingTab('${tabId}'); return false;"]`).classList.add('active');
        }

        // Function to toggle the reply form visibility
        function showReplyForm(commentId) {
            const replyForm = document.getElementById(`reply-form-${commentId}`);
            if (replyForm) {
                replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Document ready event listener
        $(document).ready(function() {
            // Initialize default tabs
            showContentTab('episodes-tab');
            showCommentRatingTab('comments-subtab');

            // Handle collapse episodes toggle
            const collapseToggle = document.getElementById('collapseEpisodes');
            const episodeGrid = document.getElementById('episodeGrid');
            if (collapseToggle && episodeGrid) {
                collapseToggle.addEventListener('change', function() {
                    episodeGrid.style.display = this.checked ? 'none' : 'flex'; // Or 'grid' depending on your CSS
                });
            }

            // --- Handle Favorite Button Click ---
            $('#favorite-action-link').on('click', function(e) {
                e.preventDefault(); // Prevent default link behavior

                const link = $(this);
                const movieId = link.data('movie-id');
                const userId = link.data('user-id'); // Get user ID from data attribute
                let isFavorited = link.data('is-favorited') === true; // Get current favorite status as boolean

                // If the user is not logged in, prompt them to log in
                if (!userId) {
                    alert("Vui lòng đăng nhập để thêm phim vào danh sách yêu thích.");
                    // Optionally redirect to login page:
                    // window.location.href = '@Url.Action("Login", "Account")';
                    return;
                }

                // Perform AJAX request to toggle favorite status
                $.ajax({
                    url: '@Url.Action("ToggleFavorite", "Movies")', // Ensure this matches your controller action path
                    type: 'POST',
                    data: {
                        movieId: movieId,
                        // Include the CSRF token for security.
                        // It's recommended to include this if your server requires it for POST requests.
                        // If your _Layout.cshtml renders it, you can get it like this:
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                        // If it's not rendered, you might need to configure AJAX globally or get it from a meta tag.
                    },
                    dataType: 'json', // Expect JSON response from the server
                    success: function(response) {
                        if (response.success) {
                            // Update UI based on the response from the server
                            isFavorited = response.isFavorited; // Update local status variable
                            link.data('is-favorited', isFavorited); // Update data attribute for future clicks

                            if (isFavorited) {
                                // Movie is now favorited
                                link.addClass('favorited');
                                link.find('i').removeClass('far fa-heart').addClass('fas fa-heart');
                                // Optional: Show a temporary success message (e.g., toast notification)
                                // alert("Đã thêm vào danh sách yêu thích!");
                            } else {
                                // Movie is now unfavorited
                                link.removeClass('favorited');
                                link.find('i').removeClass('fas fa-heart').addClass('far fa-heart');
                                // Optional: Show a temporary success message
                                // alert("Đã gỡ khỏi danh sách yêu thích.");
                            }
                            // You might also want to update a favorite count displayed elsewhere on the page
                        } else {
                            // Handle error response from the server
                            alert("Lỗi khi cập nhật danh sách yêu thích: " + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        // Handle network or server errors
                        console.error("AJAX Error:", status, error);
                        alert("Đã xảy ra lỗi mạng hoặc máy chủ. Vui lòng thử lại.");
                    }
                });
            });
        });
    </script>

    @* CSS for the favorited state and readonly form inputs *@
    <style>
        .action-item.favorited {
            color: #e74c3c; /* Red color for favorited state */
        }
        .action-item.favorited i {
            color: #e74c3c; /* Ensure icon also matches */
        }
        /* Styles for comment/rating forms and their readonly inputs */
        .comment-form .form-group input[readonly],
        .comment-form .form-group textarea[readonly] {
            background-color: #3a3a5a; /* Darker background for readonly fields */
            color: #b0b0b0; /* Lighter text color for readonly fields */
            cursor: not-allowed; /* Indicate it's not editable */
        }
        /* Add any other specific styles you might need for the rating section or tabs */
    </styl>
} 